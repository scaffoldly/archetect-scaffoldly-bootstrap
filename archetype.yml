---
script:
  - set:
      hash-banner:
        default: |
          ## THIS FILE IS AUTOMATICALLY GENERATED BY SCAFFOLDLY  ##
          ## CONFIG CAN BE CHANGED AT: https://start.scaffold.ly ##
      readme-banner:
        default: |
          > :warning: THIS FILE IS AUTOMATICALLY GENERATED BY [SCAFFOLDLY](https://start.scaffold.ly) :warning:

  - if:
      all-of:
        - switch-enabled: overwrite
      then:
        - rules:
            - destination:
                overwrite: false
        - render:
            directory:
              source: "immutable"

  - rules:
      - destination:
          overwrite: true

  - if:
      all-of:
        - switch-enabled: base
      then:
        - render:
            directory:
              source: "base"

  - if:
      all-of:
        - switch-enabled: github
      then:
        - render:
            directory:
              source: "github"

  - if:
      all-of:
        - switch-enabled: base
        - switch-enabled: aws
        - switch-enabled: aws-base
      then:
        - set:
            nonlive-domain:
              prompt: "Nonlive Domain"
            nonlive-subdomain-suffix:
              default: ""
            nonlive-cdn-domains:
              default: "[]"
              type: list
            nonlive_cdn_domains_formatted:
              value: '"{{ nonlive-cdn-domains | join(sep=''","'') }}"'
            live-domain:
              default: ""
            live-subdomain-suffix:
              default: ""
            serverless-api-subdomain:
              default: ""
            live-cdn-domains:
              default: "[]"
              type: list
            live_cdn_domains_formatted:
              value: '"{{ live-cdn-domains | join(sep=''","'') }}"'
        - render:
            directory:
              source: "aws/base"

  - if:
      all-of:
        - switch-enabled: serverless-api
      then:
        - set:
            serverless-api-repos:
              type: list

  - if:
      all-of:
        - switch-enabled: aws
        - switch-enabled: serverless-api
      then:
        - for:
            item:
              in: serverless-api-repos
              name: repository-name
            do:
              - info: "Rendering AWS Serverless API for repository: {{ repository-name }}"
              - set:
                  repo:
                    value: "{{ repository-name | lower }}"
                  service_name:
                    value: "{{ repo | snake_case }}"
                  service-name:
                    value: "{{ repo | train_case }}"
                  path:
                    value: "{{ repo | trim_end_matches(pat='-sls-rest-api') }}"
              - render:
                  directory:
                    source: "aws/serverless-api"
              - if:
                  all-of:
                    - switch-enabled: github
                  then:
                    - info: "Rendering GitHub Config for repository: {{ repository-name }}"
                    - render:
                        directory:
                          source: "aws/serverless-api-github"

  - if:
      all-of:
        - switch-enabled: cdn
      then:
        - set:
            cdn-repos:
              type: list

  - if:
      all-of:
        - switch-enabled: aws
        - switch-enabled: cdn
      then:
        - for:
            item:
              in: cdn-repos
              name: repository-name
            do:
              - info: "Rendering AWS CDN for repository: {{ repository-name }}"
              - set:
                  repo:
                    value: "{{ repository-name | lower }}"
                  service_name:
                    value: "{{ repo | snake_case }}"
                  service-name:
                    value: "{{ repo | train_case }}"
                  service-slug:
                    value: "{{ repo | trim_end_matches(pat='-web-angular') }}"
              - render:
                  directory:
                    source: "aws/cdn"
              - if:
                  all-of:
                    - switch-enabled: github
                  then:
                    - info: "Rendering GitHub Config for repository: {{ repository-name }}"
                    - render:
                        directory:
                          source: "aws/cdn-github"

  - if:
      all-of:
        - switch-enabled: addon-aws-ses
      then:
        - render:
            directory:
              source: "addons/aws/ses"

  - exec:
      command: terraform
      args:
        - "fmt"
