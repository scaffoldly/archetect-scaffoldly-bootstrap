---
script:

  - set:
      hash-banner:
        default: |
          ## THIS FILE IS AUTOMATICALLY GENERATED BY SCAFFOLDLY  ##
          ## CONFIG CAN BE CHANGED AT: https://start.scaffold.ly ##
      readme-banner:
        default: |
          > :warning: THIS FILE IS AUTOMATICALLY GENERATED BY [SCAFFOLDLY](https://start.scaffold.ly) :warning:

  - render:
      directory:
        source: "immutable"

  - if:
      conditions:
        - switch-enabled: overwrite
        - switch-enabled: base
      then:
        - rules:
            - destination:
                overwrite: true
        - render:
            directory:
              source: "base"

  - if:
      conditions:
        - switch-enabled: overwrite
        - switch-enabled: github
      then:
        - rules:
            - destination:
                overwrite: true
        - render:
            directory:
              source: "github"

  - if:
      conditions:
        - switch-enabled: overwrite
        - switch-enabled: base
        - switch-enabled: aws
        - switch-enabled: aws-base
      then:
        - set:
            nonlive-domain:
              prompt: "Nonlive Domain"
            nonlive-subdomain-suffix:
              default: ""
            live-domain:
              prompt: "Live Domain"
              default: ""
            live-subdomain-suffix:
              default: ""
            serverless-api-subdomain:
              default: ""
        - rules:
            - destination:
                overwrite: true
        - render:
            directory:
              source: "aws/base"

  - if:
      conditions:
        - switch-enabled: serverless-api
      then:
          - set:
              serverless-api-repos:
                type: list

  - if:
      all-of: 
        - switch-enabled: overwrite
        - switch-enabled: aws
        - switch-enabled: serverless-api
      then:
        - for:
            item:
              in: serverless-api-repos
              name: repository-name
            do:
              - info: "Rendering AWS Serverless API for repository: {{ repository-name }}"
              - set:
                  repo: 
                    value: "{{ repository-name | lower }}"
                  service_name: 
                    value: "{{ repo | snake_case }}"
                  service-name: 
                    value: "{{ repo | train_case }}"
                  path: 
                    value: "{{ repo | trim_end_matches(pat='-sls-rest-api') }}"
              - rules:
                  - destination:
                      overwrite: true
              - render:
                  directory:
                    source: "aws/serverless-api"
              - if:
                  all-of:
                    - switch-enabled: github
                  then:
                    - info: "Rendering GitHub Config for repository: {{ repository-name }}"
                    - rules:
                      - destination:
                          overwrite: true
                    - render:
                        directory:
                          source: "aws/serverless-api/github"

  - if:
      conditions:
        - switch-enabled: overwrite
        - switch-enabled: addon-aws-ses
      then:
        - render:
            directory:
              source: "addons/aws/ses"

  - exec:
      command: terraform
      args:
        - "fmt"